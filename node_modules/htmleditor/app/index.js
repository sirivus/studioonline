var express = require("express"),
    app = express(),
    engines = require("consolidate"),
    domain = require("../domain"),
    query = require("../query"),
    Middle = require("../../jsdm.middle"),
    middle = new Middle(domain,query);

domain.exec("init");

app.listen(3000);

app.use(express.static('public'));
app.use(express.bodyParser());
app.use(express.cookieParser('leo'));
app.use(express.session());
app.post("/domain",middle.middle);
app.set('view engine','html');
app.set('views','views')
app.engine("html",engines.ejs);

function newarticles(req,res,next){
    var skip = parseInt(req.query.skip);
    if(skip){
        skip = 0;
    }
    query.articleByTime(skip,function(rs){
        res.locals.articles = rs;
        res.locals.nav = query.nav;
        res.locals.parent = undefined;
        next();
    })
}

function typearticles(req,res,next){
    var skip = parseInt(req.query.skip),
        type = req.query.type;

    if(skip){
        skip = 0;
    }
    query.articleByType(type,skip,function(rs){
        res.locals.articles = rs;
        res.locals.nav = query.nav;
        res.locals.parent = type?type.parent:undefined;
        next();
    })
}

app.get("/",newarticles,function(req,res){
    res.render("cms/index")
})

app.get("/search",typearticles,function(req,res){
    res.render("cms/index")
})