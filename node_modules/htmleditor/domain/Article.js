var m = require("../../strict-method");

function wrap(repos, services, publish) {

    function Article(type,title,content){

        this._title = title;
        this._content = content;
        this._readCount = 0;
        this._createTime = Date.now();
        this._updateTime = Date.now();
        this._top = false;
        this._labels = [];
        this._type = type;
    }

    Article.prototype = {

        change:m(String,String,function(title,content){
            this._title = title;
            this._content = content;
            this._updateTime = Date.now();
            this._publishChangeEvent({title:title,content:content,updateTime:this._updateTime});
        }),
        changeType:function(type){
            var self = this;
            repos.Navigation.get("id001",function(err,nav){
                if(nav){
                   var n = nav.getNode(type);
                   if(n){
                      self.type = type;
                      this._publishChangeEvent({type:type});
                   }
                }
            })
        },

        read:function(){
            this._readCount += 1;
            this._publishChangeEvent({readCount:this._readCount});
        },

        get id(){
            return this._id;
        },

        _publishChangeEvent:function(update_data){
            publish("article changed",this.id,update_data);
        },

        top:function(){
            this._top = true;
            this._updateTime = Date.now();
            this._publishChangeEvent({top:true,updateTime:this._updateTime});
        },

        addLabel:m(String,function(labelId){
            if(-1 === this._labels.indexOf(labelId)){
                this._labels.push(labelId);
                this._publishChangeEvent({labels:this._labels});
            }
        })

    }

    Article.className = "Article";
    return Article;
}

module.exports = wrap;